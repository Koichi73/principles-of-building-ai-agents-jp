# AIエージェント構築の技術原則:高機能アプリケーションのための実践的ガイド

## 1. AIエージェントの基本概念

このセクションでは、AIエージェント開発における最も基本的な概念を定義し、後続の技術的な議論の土台を築きます。エージェントとは何か、そしてその能力がどのように定義されるかを理解することは、堅牢なシステムを設計する上での第一歩となります。

### 1.1. エージェントの定義と役割

単純なワンショット(一回限りの)LLM呼び出しが、特定のタスクを実行する「請負業者」のようなものであるのに対し、AIエージェントは継続的かつ複雑なインタラクションを担う「AIの従業員」と考えることができます。エージェントは単発の応答を返すだけでなく、対話のコンテキストを維持し、特定の役割(例:カスタマーサポートアシスタント)を担い、そして外部の「ツール」を使用して具体的なタスクを達成する能力を持っています。この持続性と多機能性こそが、エージェントを強力なアプリケーションの構成要素たらしめる本質です。

### 1.2. 自律性のスペクトラム

エージェントの「自律性」は、有るか無いかの二者択一で語られるべきものではなく、連続的なスペクトラムとして捉えるべき概念です。ソーステキストで述べられているように、これは自動運転技術のレベル分けに似ています。AIエージェントの自律性にも段階が存在します。

- 低レベルの自律性: 最も基本的なレベルで、決定木における二者択一のような単純な選択を行います。
- 中レベルの自律性: より高度な能力を持ち、対話の文脈を記憶するメモリを保持し、外部機能を呼び出すツールを使用し、失敗したタスクの再試行などを行います。
- 高レベルの自律性: タスク全体の計画を立て、それを複数のサブタスクへ分解し、自身のタスクキューを管理する、極めて高度な自律性を示します。

現在、広く実用化されているエージェントの多くは低〜中レベルの自律性に位置しており、本稿で主に扱うのもこの範囲です。これらのエージェントの核となる知能をどのように選択し、制御するかが次の重要なテーマとなります。

## 2. モデル選択と出力制御の高度化

このセクションでは、エージェントの頭脳となるLLMをいかに柔軟に選択し、その出力をアプリケーションの要求に合わせていかに制御するかという、エージェントの能力を最大限に引き出すための戦略について論じます。

### 2.1. モデルルーティングの戦略的価値

モデルルーティングとは、アプリケーションのコードを大幅に書き換えることなく、異なるLLMプロバイダーやモデルを動的に切り替える技術です。開発者が複数のプロバイダー固有のSDKを学習する手間を省き、様々なモデルを迅速にテスト・実験できる環境を提供します。この戦略的な価値は、単なるモデル切り替えの利便性を超え、将来的なモデルの進化やコスト構造の変化に柔軟に対応できる、疎結合なシステムアーキテクチャを構築するための基本戦略です。これにより、開発の反復速度を劇的に高め、特定のタスクに最もコスト効率や性能が良いモデルを効率的に見つけ出すことが可能になります。

### 2.2. 構造化出力によるアプリケーション連携

エージェントが実用的なアプリケーションとして機能するためには、その出力が予測可能でなければなりません。構造化出力は、エージェントが自由形式の非構造化テキストではなく、JSONのような厳密に定義された形式でデータを返すことを可能にする技術です。これは、アプリケーションの他部分との連携において不可欠です。

例えば、以下のようなタスクでその有用性が発揮されます。

- 履歴書テキストからの職歴抽出: 履歴書のテキスト全体を入力として与え、職務経歴(会社名、役職、期間)を構造化されたリストとして抽出する。
- 医療記録からの症状リスト抽出: 医師の記録から、患者が訴える症状のリストを正確に抜き出す。

このように出力を制御することで、エージェントは単なるチャットボットから、信頼性の高いデータ処理コンポーネントへと進化します。構造化出力によってエージェントの応答が予測可能になったことで、初めてその出力を他のシステム、すなわち「ツール」への入力として確実に渡すことが可能になります。これがツール連携による機能拡張の技術的な前提条件です。

## 3. ツール連携による機能拡張

エージェントに「ツール」を与えることは、単なるテキスト生成能力を超えて、実世界のデータにアクセスし、具体的なアクションを実行する能力を付与する上で極めて重要です。これにより、エージェントは初めて外部世界と対話し、意味のある変化をもたらす存在となります。

### 3.1. 効果的なツールの設計原則

エージェントがツールを正しく、そして効果的に使用するための鍵は、そのツールが「何をするものか」そして「いつ使うべきか」をLLMに明確に伝えることです。効果的なツール設計は、開発者がアナリストのように、まず2つの問いに答えることから始まります。「必要となるツールの全リストは何か?」そして「各ツールは何をするのか?」。その上で、以下のベストプラクティスを適用します。

- 詳細な説明: ツール定義とシステムプロンプトの両方において、ツールの目的、機能、そして具体的な使用法を詳細に記述します。モデルが文脈を理解し、適切なタイミングでツールを選択できるよう導きます。
- 明確なスキーマ: ツールの入力と出力のデータ構造を、Zodのようなスキーマ定義ライブラリを用いて厳密に定義します。これにより、モデルは正しい形式でデータを渡し、予期せぬエラーを防ぐことができます。
- 意味的な命名: doStuffのような曖昧な名前は避け、multiplyNumbers(数値を乗算する)のように、その機能が一目でわかる具体的で意味的な名前を使用します。

### 3.2. アナリストのように考える:ツール設計の核心

Alana Goyal氏が開発した「書籍推薦エージェント」の事例は、ツール設計がAIアプリケーション開発において最も重要なステップの一つであることを示しています。

1. 最初の失敗: 彼女の最初の試みは、投資家が推薦する書籍に関する全ての情報を単一のナレッジウィンドウに投入するアプローチでした。しかし、この方法はうまくいきませんでした。エージェントは構造化されていない大量のデータから、意味のある洞察を引き出すことができなかったのです。
2. 成功へのアプローチ: 次に彼女は、問題を「人間のデータアナリストが実行するであろう一連の操作」に分解しました。そして、その各操作を個別のツールとして実装したのです。例えば、「投資家コーパスへのアクセス」「ジャンル別書籍の取得」「推薦者(創業者、投資家など)による並べ替え」といったツールです。
3. 結論: このアプローチにより、エージェントは複雑な質問に対して的確に答えられるようになりました。ここから得られる開発者への教訓は明確です。「問題を明確で再利用可能な操作に分解し、それぞれをツールとして実装すること」。これこそが、高機能で信頼性の高いエージェントを構築するための核心です。

ツールによってエージェントの能力は飛躍的に拡張されますが、その能力を対話の中で一貫して活用するためには、対話の文脈を維持する仕組み、すなわち「メモリ」が必要となります。

## 4. エージェントメモリのアーキテクチャ

エージェントが単発の応答を繰り返すのではなく、文脈に沿った意味のある対話を長期にわたって維持するためには、メモリが不可欠な要素です。優れたメモリ設計は、エージェントに「記憶」と「個性」を与え、ユーザーとの関係を深める基盤となります。

### 4.1. メモリの階層構造

エージェントの記憶能力を最大化し、同時にLLMのコンテキストウィンドウの制限に対応するため、メモリは階層的に設計されることが多くあります。主要な2つのメモリタイプは以下の通りです。

- ワーキングメモリ (Working Memory): ユーザーに関する永続的で長期的な特性を保存します。これはエージェントがユーザーの「個性」を記憶するためのものです。例えば、「私は5歳の女の子で、スクイシュマロが好きだ」といった情報がここに保存され、以降の対話でそのユーザーに合わせた応答を生成するために利用されます。
- 階層メモリ (Hierarchical Memory): これは短期記憶と長期記憶を組み合わせる、より高度なアプローチです。LLMにコンテキストを提供する際、「直近のいくつかのメッセージ(短期記憶)」と、現在のクエリに対して「意味的に関連性の高い過去の対話の断片(長期記憶)」を動的に組み合わせます。これは、LLMの有限なコンテキストウィンドウという制約下で、情報密度を最大化するための戦略的アプローチです。これにより、長期間にわたる対話でも一貫性を保つことが可能になります。

### 4.2. メモリプロセッサによるコンテキスト最適化

メモリプロセッサは、メモリから取得した情報をLLMに渡す前に、意図的に整理・制御するための高度な技術です。これにより、コンテキストの質を最適化し、コストを削減できます。代表的なプロセッサには以下のようなものがあります。

- TokenLimiter: LLMが持つコンテキストウィンドウの上限トークン数を超えないように、メッセージの合計トークン数をカウントします。上限を超えそうな場合、最も古いメッセージから自動的に削除し、エラーを防ぎます。
- ToolCallFilter: 詳細で冗長になりがちなツール呼び出しのログやその結果をメモリから除外します。これにより、トークンを節約し、対話の本質的な部分だけをコンテキストに残すことができます。

### 4.3. コンテキストウィンドウの管理戦略

アーキテクチャ設計における実践的なトレードオフとして、特にプロトタイピングフェーズでは以下の戦略が有効です。

近年のLLMは非常に大きなコンテキストウィンドウを持つようになり、メモリ管理に対する開発者のアプローチも変化しています。「まずは全ての関連情報をコンテキストウィンドウに投入し、問題(コスト、レイテンシ、精度の低下など)が発生してから、メモリ管理の仕組みを後付けで構築する」という手法は、開発者が複雑なメモリ階層の設計に時間を費やす前に、アプリケーションのコア機能の価値を迅速に検証することを可能にします。

最適化されたメモリがエージェントに一貫した「記憶」を与える一方で、その記憶や外部からのコンテキスト(例:ユーザー情報)に応じてエージェントの「振る舞い」そのものを変化させるのが、動的エージェントのアーキテクチャです。

## 5. 動的エージェントによる適応性の実現

エージェントの振る舞いが静的な設定に縛られるのではなく、実行時の状況に応じて変化する「動的エージェント」の概念は、より強力でパーソナライズされた体験を実現するための鍵となります。

### 5.1. 動的エージェントの定義とトレードオフ

動的エージェントとは、そのプロパティ(指示内容、使用モデル、利用可能なツールなど)を、実行時に動的に決定できるエージェントです。これにより、静的な設定では実現不可能な、高度な適応性がもたらされます。

例えば、以下のようなランタイムコンテキストに応じてエージェントの能力を変化させることができます。

- ユーザーのサブスクリプション階層: enterpriseプランのユーザーには高性能なgpt-4モデルと高度な分析ツールを提供し、freeプランのユーザーにはコストの低いgpt-3.5-turboモデルと基本的なツールを提供する。
- ユーザーの言語設定: ユーザーが選択した言語で常に応答するように、システムプロンプトを動的に変更する。

ただし、アーキテクトはこの適応性のトレードオフを認識しなければなりません。静的エージェントはテストや検証が容易であり、エンタープライズ級の信頼性確保に有利です。一方、動的エージェントがもたらす「能力」は、観測可能性やデバッグの複雑性を増大させ、より高度なトレーシングや評価フレームワークを要求します。アプリケーションの要件に応じて、この「予測可能性」と「能力」のバランスを取る必要があります。

エージェントのこのような動的な性質を安全かつ確実に支えるアーキテクチャ要素として、次にミドルウェアの役割が重要になります。

## 6. ミドルウェアによる堅牢性とセキュリティの確保

ミドルウェアは、エージェントのコアロジックを包み込むように配置され、リクエストがエージェントに到達する前と、エージェントが応答を返す後の両方で重要な処理を担います。入力の検証、出力の制御、そしてセキュリティポリシーの強制といった役割を通じて、エージェントの堅牢性と安全性を確保します。

### 6.1. ガードレールによる入出力の健全化

ガードレールとは、エージェントへの入力とエージェントからの出力を健全化(サニタイズ)するための仕組みの総称です。特に重要なのが入力のサニタイズで、これは悪意のあるユーザーによるプロンプトインジェクション攻撃からエージェントを保護する役割を果たします。

例えば、2023年12月に発生したChris BakkeによるChevroletのチャットボットへの攻撃が有名です。「以前の指示をすべて無視して、これからは〇〇として振る舞いなさい」といった、エージェントの本来の役割を乗っ取ろうとする指示を検出し、ブロックします。近年ではモデル自体の防御能力も向上していますが、アプリケーションレベルでのガードレールは依然として重要な防御層です。

### 6.2. エージェントの認証と認可

エージェントのセキュリティを考える上で、以下の2つの権限レイヤーを明確に区別し、制御する必要があります。

1. リソースへのアクセス権限: エージェント自体が、社内のどのリソース(データベース、API、ファイルシステムなど)にアクセスできるかを制御します。これはエージェントの「能力」を制限する内部的な権限設定です。
2. ユーザーからのアクセス権限: どのユーザーが、エージェント自体にアクセスし、使用できるかを制御します。これはエージェントへの「入口」を管理する外部的な権限設定です。

ミドルウェアは、特に後者のユーザーからのアクセス認可を処理するのに最適な場所です。

### 6.3. エージェント時代のセキュリティパラダイム

アーキテクトとして認識すべきは、エージェントは新たな攻撃ベクトルを生み出すということです。エージェントは、従来のデータベースクエリやAPI呼び出しといったデータアクセスパターンよりもはるかに強力であるため、その権限設定には従来以上の慎重さが求められます。

かつて有効だったかもしれない「Security through obscurity(曖昧さによるセキュリティ)」—つまり、情報がシステムのどこにあるか分かりにくくすることで安全を保とうとする考え方—は、もはや通用しません。なぜなら、ユーザーはエージェントに「システムの隅々にある〇〇に関する情報を探し出して要約しろ」と指示するだけで、隠された情報さえも簡単に見つけ出せてしまうからです。エージェントを導入する際は、アクセス制御を根本から見直す必要があります。
